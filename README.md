This project aims at providing the simplest possible mean to notify mobile
devices that an interactive application should display a notification and
load the related contents from its server.

It is primarily targeting Android devices for now.

The main goals are:
 - lower the battery usage on mobile devices that run messaging apps
 - remain free of Google Play Services
 - provide very simple, very agnostic APIs
 - provide protection from a malicious notification broker
 - 
 - run properly in constrained environments
 - be extensible to as many technologies as possible in the future

Protocol
========

ACM uses WAMP as the underlying protocol. Why? MQTT is tempting but will
not run in every constrained environment, especially strongly filtered
networks. WAMP provides the required pubsub APIs over Websockets, which
are most likely to behave properly in all environments.

ACM uses WSS (Websockets over HTTPS) exclusively, for obvious security
reasons.

ACM is acentric, meaning a device can register on any ACM server, simply
by configuring the ACM endpoint. 

General scheme
--------------

Both the device (or individual applications in case the package is not
installed system-wide) and application server MUST be able to register
on the same WAMP broker.

Subscribing uses the following scheme.

1. The client system package (or application) registers on the WAMP
   broker
2. The app registers a new notification, specifying the resulting
   intent and topic type
3. The system package generates a full topic and stores the relation
   between the intent type and topic
4. The system package generates an encryption key for the notification
5. The system package subscribes to the WAMP topic
6. The application communicates the topic and encryption key to the
   application server

Notifying uses the following scheme.

1. The application server generates a notification, potentially
   attached with a structured payload
2. The current timestamp and event unique identifier are attached
   to the payload, which is then JSON-encoded
3. The notification content is encrypted using an authenticated
   encryption scheme and the key initially passed by the client
4. The notification is published on the notification topic
5. The client system package decodes and decrypts the notification
6. The client system package checks the timestamp is recent and stores
   the unique id in a short-lived cache to avoid replay attacks by the
   broker
7. The client system package generates and sends an intent, including
   the decoded JSON payload

Transport and encoding
----------------------

WAMP transport used MUST be Websocket.

WAMP encoding SHOULD be MessagePack for mobile devices.

Procedures
----------

ACM does not use any RPC features from WAMP.

Topics
------

For every type of notification an app is able to receive, a unique topic
is generated. The topic MUST be unique to the device, app, and type of
notification.

During application startup, the application registers the notification
types associated with expected intents, then the ACM client on the device
subscribes to the topic.

Topics MUST be of one of the following forms:

 - `acm.[0-9a-f]{64}`, where the hex string deterministically depends on
   the device, app and type of notification, yet is unpredictible by a
   third party
 - `acm.<app>.<type>.[0-9a-f]{64}`, where the hex string deterministically
   depends on the device, yet is unpredictible by a third party

The first form should be used when the application and type of notification
should remain confidential, even from the notification broker. In that case,
the broker is completely agnostic of the notification

The second form shoud be used when the application and type of notification
are not specifically confidential, and the application author expects brokers
to prioritize notifications based on conventions or contracts.

Notifications
-------------

A notification is an even published on a notification topic. It contains
a structured WAMP payload, with the following fields:

 - `version`, containing the protocol version
 - `payload`, containing the encrypted payload as a byte string

Current protocol version is `1`.

The plaintext payload is a JSON-encoded string with the following fields:

 - `t`, containing the current timestamp since epoch
 - `id`, containing an event id, unique per topic
 - other fields generated by the application server

It is encrypted using AES-GCM.
